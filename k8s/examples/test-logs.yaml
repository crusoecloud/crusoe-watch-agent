apiVersion: v1
kind: Namespace
metadata:
  name: log-generator
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: journald-dmesg-generator
  namespace: log-generator
spec:
  selector:
    matchLabels:
      app: journald-dmesg-generator
  template:
    metadata:
      labels:
        app: journald-dmesg-generator
    spec:
      # If you want it on all nodes including control-plane
      tolerations:
        - operator: Exists
      containers:
        - name: generator
          image: alpine:3.19
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -eu
              apk add --no-cache util-linux busybox
              i=0
              while true; do
                i=$((i+1))
                # journald (goes to systemd-journald on the node)
                logger -t crusoe-watch-agent-test "journald test message #$i from node=$(hostname)"

                # kernel ring buffer (shows up in dmesg; may also flow to /var/log/kern.log depending on node config)
                echo "<6>crusoe-watch-agent-test: dmesg test message #$i from node=$(hostname)" > /dev/kmsg || true

                sleep 5
              done
          securityContext:
            privileged: true
          volumeMounts:
            # Optional: mount journald directories if you want to inspect them from inside the pod.
            - name: var-log-journal
              mountPath: /var/log/journal
              readOnly: true
            - name: run-log-journal
              mountPath: /run/log/journal
              readOnly: true
      volumes:
        - name: var-log-journal
          hostPath:
            path: /var/log/journal
            type: DirectoryOrCreate
        - name: run-log-journal
          hostPath:
            path: /run/log/journal
            type: DirectoryOrCreate