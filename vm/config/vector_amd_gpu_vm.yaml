sources:
    host_metrics:
        type: host_metrics
        collectors:
            - cpu
            - disk
            - memory
            - network
        network:
          devices:
            excludes:
              - "lo*"
            includes:
              - "ens*"
        scrape_interval_secs: 60

    amd_metrics:
        type: prometheus_scrape
        endpoints:
            - http://localhost:${AMD_EXPORTER_PORT}/metrics
        scrape_interval_secs: 60
        scrape_timeout_secs: 50

    internal_metrics:
      type: internal_metrics
      scrape_interval_secs: 60

transforms:
    add_update_labels:
        type: remap
        inputs:
            - host_metrics
            - amd_metrics
        source: |
            del(.tags.Hostname)
            .tags.vm_id = "${VM_ID}"
            .tags.crusoe_resource = "vm"

    filter_internal_metrics:
        type: filter
        inputs:
            - internal_metrics
        condition: |
            includes(
                [
                    "vector_buffer_byte_size",
                    "vector_buffer_discarded_events_total",
                    "vector_buffer_events",
                    "vector_buffer_received_events_total",
                    "vector_buffer_send_duration_seconds",
                    "vector_buffer_sent_events_total",
                    "vector_build_info",
                    "vector_collect_completed_total",
                    "vector_collect_duration_seconds",
                    "vector_component_discarded_events_total",
                    "vector_component_errors_total",
                    "vector_component_received_events_total",
                    "vector_component_sent_events_total",
                    "vector_config_reload_rejected",
                    "vector_config_reloaded",
                    "vector_connection_established_total",
                    "vector_connection_send_errors_total",
                    "vector_http_client_requests_sent_total",
                    "vector_http_client_response_rtt_seconds",
                    "vector_http_client_responses_total",
                    "vector_http_client_rtt_seconds",
                    "vector_internal_metrics_cardinality",
                    "vector_open_connections",
                    "vector_open_files",
                    "vector_source_lag_time_seconds",
                    "vector_uptime_seconds",
                ],
                .name,
            )

    add_internal_labels:
        type: remap
        inputs:
          - filter_internal_metrics
        source: |
          .tags.vm_id = "${VM_ID}"
          .tags.crusoe_resource = "vm"
          .tags.agent_version = "${AGENT_VERSION}"

sinks:
    cms_gateway:
        type: prometheus_remote_write
        inputs:
            - add_update_labels
            - add_internal_labels
        endpoint: "${TELEMETRY_INGRESS_ENDPOINT}"
        tenant_id: "cri:vm/${VM_ID}"
        auth:
            strategy: bearer
            token: "${CRUSOE_AUTH_TOKEN}"
        healthcheck:
            enabled: false
        request:
          concurrency: adaptive
        batch:
          max_bytes: 500000 # ~500KB
        compression: snappy
        tls:
            verify_certificate: true
            verify_hostname: true
